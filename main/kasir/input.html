<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manager Dashboard - Input Penjualan</title>
  <link rel="stylesheet" href="../../css/main.css">
  <link rel="stylesheet" href="../../css/header.css">
  <style>
    /* Container form kasir */
.kasir-form {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(6px);
  padding: 2rem;
  border-radius: 15px;
  max-width: 500px;
  margin: 1rem auto;
  box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

/* Judul form */
.kasir-form .form-title {
  text-align: center;
  margin-bottom: 0.5rem;
  font-size: 1.5rem;
  font-weight: 600;
  color: #fff;
}

/* Label dan input */
.kasir-form label {
  font-weight: 500;
  color: #fff;
}

.kasir-form input[type="text"],
.kasir-form input[type="number"],
.kasir-form input[type="date"] {
  width: 100%;
  padding: 0.6rem 0.8rem;
  border-radius: 8px;
  border: none;
  outline: none;
  background: rgba(255,255,255,0.9);
  color: #333;
}

/* Date options radio */
.date-options {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.date-options label {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  color: #fff;
}

/* Tombol simpan */
.kasir-form .login-btn {
  width: 100%;
  background: #43cea2;
  color: #fff;
  border: none;
  padding: 0.8rem;
  font-size: 1rem;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s;
}

.kasir-form .login-btn:hover {
  background: #36b38f;
}

  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <h2>Kasir Dashboard</h2>
    <nav>
      <a href="/main/kasir/index.html">Home</a>
      <a href="/main/manager/prediksi.html">Prediksi</a>
      <a href="/login/login.html">Logout</a>
    </nav>
  </header>

  <!-- Konten -->
  <section class="hero">
    <h1>Input Penjualan</h1>
    <!-- Pakai class login-container & login-form supaya auto ke-style -->
    <div class="login-container-kasir">
  <form id="salesForm" class="login-form kasir-form">
    

    <label for="itemName">Nama Menu</label>
    <input type="text" id="itemName" required placeholder="Masukan nama menu">

    <label for="quantity">Jumlah Terjual</label>
    <input type="number" id="quantity" required placeholder="Masukkan jumlah">

    <label>Pilih Tanggal</label>
    <div class="date-options">
      <label>
        <input type="radio" name="dateOption" id="today" value="today" checked>
        Hari Ini (Otomatis)
      </label>
      <label class="manual-date">
        <input type="radio" name="dateOption" id="manual" value="manual">
        Masukkan Tanggal
        <input type="date" id="manualDate" disabled>
      </label>
    </div>

    <button type="submit" class="login-btn">Simpan</button>
  </form>
</div>

  </section>

  <!-- Footer -->
  <footer>
    &copy; 2025 Restoran Sehat
  </footer>
  <!-- Proteksi login -->
  <script type="module" src="../../javascript/proteksi.js"></script>

  <!-- Script Penjualan -->
  <script type="module">
    import { db } from '../../javascript/firebase.js';
    import { collection, addDoc, query, where, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const salesForm = document.getElementById('salesForm');
    const manualRadio = document.getElementById('manual');
    const todayRadio = document.getElementById('today');
    const manualDateInput = document.getElementById('manualDate');

    // enable/disable input date sesuai radio
    manualRadio.addEventListener('change', () => { manualDateInput.disabled = !manualRadio.checked; });
    todayRadio.addEventListener('change', () => { manualDateInput.disabled = manualRadio.checked ? false : true; });

    salesForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const itemName = document.getElementById('itemName').value;
      const quantity = parseInt(document.getElementById('quantity').value);

      // ambil tanggal sesuai pilihan
      let selectedDate = new Date();
      if(manualRadio.checked){
        const dateValue = manualDateInput.value;
        if(!dateValue){ alert('Mohon pilih tanggal!'); return; }
        selectedDate = new Date(dateValue);
      }
      const dateStr = selectedDate.toISOString().split('T')[0]; // format yyyy-mm-dd

      try {
        const salesRef = collection(db, 'sales');
        const q = query(salesRef, where("item", "==", itemName));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
          // update dokumen existing
          querySnapshot.forEach(async (document) => {
            const data = document.data();
            let salesArray = data.sales || [];

            const existingIndex = salesArray.findIndex(s => s.date === dateStr);
            if(existingIndex >= 0){
              salesArray[existingIndex].quantity += quantity;
            } else {
              salesArray.push({date: dateStr, quantity: quantity});
            }

            await updateDoc(doc(db, 'sales', document.id), { sales: salesArray });
          });
          alert('Jumlah penjualan berhasil diperbarui!');
        } else {
          // buat dokumen baru
          await addDoc(salesRef, {
            item: itemName,
            sales: [{date: dateStr, quantity: quantity}]
          });
          alert('Data penjualan tersimpan!');
        }

        salesForm.reset();
        manualDateInput.disabled = true;

      } catch (err) {
        console.error('Error saat menyimpan data: ', err);
        alert('Gagal menyimpan data: ' + err.message);
      }
    });
  </script>

</body>
</html>
